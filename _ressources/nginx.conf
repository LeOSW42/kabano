# --- Kabano: essayer public/<path> d'abord, sinon fallback vers public/index.php?q=... ---

# Prépare la variable q sans slash initial (ex: wiki/restauration-de-refuges)
if ($uri ~ ^/(.*)) {
    set $kabano_q $1;
}

# Si le fichier existe physiquement sous $document_root/public$uri, on réécrit l'URI vers /public$uri
# et on relance la résolution des locations (last) pour que nginx serve le fichier statique.
# (Cette condition n'a d'effet que si root pointe au repo root et que les fichiers sont dans public/)
if (-f $document_root/public$uri) {
    rewrite ^(.*)$ /public$1 last;
}

# Si rien n'existe (404), interceptor et faire une internal rewrite vers /public/index.php
# avec q (sans leading slash) et la query string d'origine.
# =200 évite une boucle d'erreur si l'index renvoie 404 côté application.
error_page 404 =200 /public/index.php?q=$kabano_q&$args;

# -------------------------------------------------------------------------------